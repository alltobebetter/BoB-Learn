# 闭包

闭包是编程中一个重要的概念，它允许内部函数访问其外部函数的作用域，即使外部函数已经执行完毕。在 Python 中，闭包与函数是一等公民的特性紧密相关，这意味着函数可以像其他对象一样被传递和使用。

**简单理解：**

想象一下一个工具箱（外部函数），里面有一把特殊的螺丝刀（内部函数）。这把螺丝刀只能在这个工具箱里使用，它依赖于工具箱里的一些其他工具（外部函数的变量）。即使你把螺丝刀拿出来（返回内部函数），它仍然“记得”工具箱里的环境，可以继续使用那些工具。这个“记忆”的机制就是闭包。

**关键要素：**

1. **嵌套函数：** 闭包必须包含一个嵌套的内部函数。
2. **内部函数引用外部函数的变量：** 内部函数必须引用其外部函数作用域中的变量（自由变量）。
3. **返回内部函数：** 外部函数必须返回内部函数。

**代码示例：**

```python
def outer_function(x):
  """外部函数"""
  def inner_function(y):
    """内部函数"""
    return x + y  # 引用外部函数的变量 x
  return inner_function  # 返回内部函数

add_5 = outer_function(5)  # 调用外部函数，并将返回值（内部函数）赋值给 add_5
add_10 = outer_function(10)

print(add_5(3))  # 输出 8  (5 + 3)
print(add_10(3)) # 输出 13 (10 + 3)
```

**解释：**

1. `outer_function` 是外部函数，`inner_function` 是内部函数。
2. `inner_function` 引用了 `outer_function` 的变量 `x`。
3. `outer_function` 返回了 `inner_function`。

当我们调用 `outer_function(5)` 时，它返回 `inner_function` 的一个实例，并将 `x` 的值绑定为 5。这个 `inner_function` 的实例连同其环境（`x=5`）一起形成了一个闭包。即使 `outer_function` 已经执行完毕，`add_5` 仍然“记得” `x` 的值是 5，所以 `add_5(3)` 可以正确计算出 8。


**闭包的用途：**

* **数据封装和隐藏：** 闭包可以隐藏内部函数的实现细节，只暴露必要的接口。
* **状态保持：** 闭包可以保存状态，即使外部函数已经执行完毕。例如，在上面的例子中，`add_5` 保留了 `x=5` 的状态。
* **装饰器：** Python 的装饰器就是基于闭包实现的。
* **回调函数：** 闭包可以用来创建回调函数，例如在 GUI 编程中。
* **创建函数工厂：** 可以根据不同的参数创建不同的函数。


**与普通函数的区别：**

普通函数在执行完毕后，其局部变量会被销毁。而闭包可以保留外部函数的变量，即使外部函数已经执行完毕。


**总结：**

闭包是 Python 中一个强大的特性，它允许内部函数访问其外部函数的作用域，从而实现数据封装、状态保持等功能。理解闭包对于理解 Python 的高级特性（如装饰器）至关重要。 通过上面的解释和例子，相信你对 Python 闭包有了更清晰的理解。


**进阶理解 -  自由变量 (Free Variables):**

闭包中，内部函数引用的外部函数变量被称为“自由变量”。 这些变量既不是内部函数的局部变量，也不是全局变量。  Python 使用 `__closure__` 属性来存储这些自由变量的值。 你可以用下面的代码来查看：

```python
print(add_5.__closure__) #  (<cell at 0x...: int object at 0x...>,)
print(add_5.__closure__[0].cell_contents) # 5
```

这展示了 `add_5` 闭包捕获了 `x` 的值 (5)。  理解自由变量的概念有助于更深入地理解闭包的工作机制。
